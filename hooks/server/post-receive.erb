<%= shebang %>

# This script is SH-compatible, but it doesn't mean you have to use SH.
# You can use bash or zsh and enjoy features of more powerful shells, just change the shebang!

# POST-RECEIVE HOOK
# ARGV: empty
# STDIN: [OLD HEAD] [NEW HEAD] refs/heads/alpha

<% if colors %>
export TERM="xterm-color"

abort()   { printf "\e[1;31m$*\e[0m\n"; exit 1; }
success() { printf "\e[1;32m$*\e[0m\n"; }
info()    { printf "\e[1;34m$*\e[0m\n"; }
debug()   { $DEBUG && printf "\e[1;33m$*\e[0m\n"; }
<% else %>
abort()   { printf "$*\n"; exit 1; }
success() { printf "$*\n"; }
info()    { printf "$*\n"; }
debug()   { $DEBUG && printf "$*\n"; }
<% end %>
run()     { info $* ; $*; }

set -- $(cat /dev/stdin)

old=$1 && new=$2 && ref=$3
export BRANCH=$(basename $ref)
export DEBUG=<%= debug %>
<% if branch %>
# restrict deployment just to given branch
if [ $BRANCH != <%= branch %> ]
  info "Branch $BRANCH isn't supposed to be deployable, finishing"
  exit
fi
<% end %>

# POST-UPDATE HOOK
# ARGV: $1 is BRANCH
# STDIN: ?
#BRANCH=$(basename $1)

cd ..
root=`pwd`

# GIT_DIR is "." which should points to bare repozitory
GIT_DIR="`pwd`/webs/$BRANCH/.git"

info "Reading /etc/profile ..."
. /etc/profile

debug
debug "=== Environment ==="
debug "PATH: $PATH"
debug "USER: $USER"
debug "TERM: $TERM"
debug "Ruby version: $(ruby --version)"
debug "Ruby path: $(which ruby)"
debug

if [ -d "webs/$BRANCH" ] ; then
  cd webs/$BRANCH
  info "Updating $BRANCH in `pwd` ... (from $old' to '$new')"
  git fetch
  git reset $new --hard
else
  info "Cloning $BRANCH to $(pwd)/webs/$BRANCH (HEAD: '$new') ..."
  git clone repo.git webs/$BRANCH
  cd webs/$BRANCH
  if [ -x "hooks/clone" ] ; then
    info "[$PWD] Running clone hook"
    exec "./hooks/clone"
  elif [ -f "hooks/clone" ] ; then
    info "[$PWD] Loading clone hook"
    . "./hooks/clone" # so user can use functions defined in this hook in his clone hook
    exit $?
  else
    abort "No clone hook found!"
  fi
fi

# Update hook
if [ -x "hooks/update" ] ; then
  info "[$PWD] Running update hook"
  exec "./hooks/update"
elif [ -f "hooks/update" ] ; then
  info "[$PWD] Loading update hook"
  . "./hooks/update" # so user can use functions defined in this hook in his update hook
  exit $?
else
  abort "No update hook found!"
fi
